@page "/posts/new"
@using BlazorApp.Services
@inject IPostService Posts
@inject ICurrentUser CurrentUser
@inject NavigationManager Nav

<h2>New Post</h2>

@if (!string.IsNullOrWhiteSpace(_error)) { <p class="text-danger">@_error</p> }

<EditForm Model="_model" OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label>Title</label>
        <InputText @bind-Value="_model.Title" class="form-control" />
    </div>

    <div class="mb-3">
        <label>Body</label>
        <InputTextArea @bind-Value="_model.Body" class="form-control" rows="6" />
    </div>

    <button class="btn btn-success" type="submit">Create</button>
    <a class="btn btn-secondary ms-2" href="/posts">Cancel</a>
</EditForm>

@code {
    private string? _error;
    private ApiContracts.DTOs.CreatePostDTO _model = new() { Title = "", Body = "" };

    private async Task HandleSubmit()
    {
        try
        {
            _model.UserId = CurrentUser.UserId; // Step 5.3
            var created = await Posts.AddAsync(_model);
            Nav.NavigateTo($"/posts/{created.Id}");
        }
        catch (Exception ex) { _error = ex.Message; }
    }
}